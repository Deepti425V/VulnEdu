<!-- FIXED index.html template - removed syntax error at line 14 -->
{% extends "base.html" %}

{% block head %}
<style>
/* Scrollable year filter styling - matches CWE list theme */
/* Custom scrollbar for year dropdown to handle long lists of years */
select[name="year"] {
    max-height: 200px; /* Limit dropdown height */
    overflow-y: auto !important; /* Force scrollbar when needed */
}

/* Custom scrollbar styling for year dropdown - WebKit browsers */
select[name="year"]::-webkit-scrollbar {
    width: 8px; /* Thin scrollbar for space efficiency */
}

select[name="year"]::-webkit-scrollbar-track {
    background: #1a2236; /* Match dashboard theme */
    border-radius: 4px;
}

select[name="year"]::-webkit-scrollbar-thumb {
    background: #63a4ff; /* Brand blue for thumb */
    border-radius: 4px;
    border: 1px solid #263159; /* Subtle border for definition */
}

select[name="year"]::-webkit-scrollbar-thumb:hover {
    background: #5292e6; /* Slightly darker on hover */
}

select[name="year"]::-webkit-scrollbar-thumb:active {
    background: #4a80cc; /* Even darker when clicked */
}

/* Firefox scrollbar styling */
select[name="year"] {
    scrollbar-width: thin; /* Thin scrollbar style */
    scrollbar-color: #63a4ff #1a2236; /* Thumb and track colors */
}

/* Ensure dropdown opens properly with consistent option styling */
select[name="year"] option {
    background: #222d44; /* Dark background for options */
    color: #cdd7f7; /* Light text for readability */
    padding: 8px; /* Comfortable padding for options */
}
</style>
{% endblock %}

{% block content %}
<!-- ======= MAIN DASHBOARD CONTAINER ========= -->
<div style="display: flex; flex-direction: column; gap: 36px">
    <!-- Header Section: Title and Search/Filter Controls -->
    <div style="display:flex; justify-content:space-between; align-items:center;">
        <!-- Title and subtitle -->
        <div>
            <h1 style="margin:0;color:#63a4ff;letter-spacing:1px;font-size:1.8rem;">
                Educational CVE Analysis Tool
            </h1>
            <div style="color:#a9add1;margin-top:4px;font-size:1.07rem;">
                Dashboard &amp; Analytics
            </div>
        </div>
        
        <!-- Search + filtering form -->
        <form style="display:flex;gap:18px;" method="get" action="{{ url_for('index') }}">
            <!-- Text search input -->
            <input type="text" name="q" value="{{ search_query or '' }}"
                   placeholder="ðŸ” Search CVEs"
                   style="padding:9px;font-size:1rem;background:#222d44;color:#cdd7f7;border:none;border-radius:7px;">
            
            <!-- Severity filter dropdown -->
            <select name="severity"
                    style="background:#222d44;color:#cdd7f7;padding:9px;border:none;border-radius:7px;">
                <option value="" {% if not severity_filter %}selected{% endif %}>All Severities</option>
                <option value="CRITICAL" {% if severity_filter == 'CRITICAL' %}selected{% endif %}>Critical</option>
                <option value="HIGH" {% if severity_filter == 'HIGH' %}selected{% endif %}>High</option>
                <option value="MEDIUM" {% if severity_filter == 'MEDIUM' %}selected{% endif %}>Medium</option>
                <option value="LOW" {% if severity_filter == 'LOW' %}selected{% endif %}>Low</option>
            </select>
            
            <!-- Year filter -->
            <select name="year"
                    style="background:#222d44;color:#cdd7f7;padding:9px;border:none;border-radius:7px;">
                    <option value="" {% if not year_filter %}selected{% endif %}>All Years</option>
               {% for y in available_years %}
               <option value="{{ y }}" {% if year_filter == y %}selected{% endif %}>{{ y }}</option>
               {% endfor %}
           </select>
           
           <!-- Month filter -->
           <select name="month"
                   style="background:#222d44;color:#cdd7f7;padding:9px;border:none;border-radius:7px;">
               <option value="" {% if not month_filter %}selected{% endif %}>All Months</option>
               {% for m in available_months %}
               <option value="{{ m }}" {% if month_filter == m %}selected{% endif %}>{{ "%02d"|format(m) }}</option>
               {% endfor %}
           </select>
           
           <!-- Submit button -->
           <button type="submit"
                   style="background:#63a4ff;color:white;border:none;padding:10px 18px;border-radius:7px;font-weight:700;">
               Filter
           </button>
       </form>
   </div>

   <!-- First Row: Daily Trends + Severity Overview Cards -->
   <div style="display: flex; gap: 25px;">
       <!-- CVE Trends Daily SparkLine Card -->
       <div class="trend-sevi-blocks" style="display: flex; flex-direction:column; justify-content: center;
                                           background:#1a2236; border-radius:18px; padding:20px;
                                           width:380px; height: 110px;">
           <div style="font-weight:700; color:#63a4ff; margin-bottom:8px;
                      font-size: 1.02rem; letter-spacing:0.15px; text-align:left;">
               CVE Trends (Last 7 days)
           </div>
           <!-- Canvas for Chart.js sparkline visualization -->
           <canvas id="dailyTrendChart" height="70"></canvas>
       </div>
       
       <!-- Severity Cards Grid -->
       <div style="display: grid; grid-template-columns: repeat(4, 1fr);
                  gap:15px; flex: 1; align-items:stretch;">
           <!-- Critical Severity Card -->
           <div class="severity-card" data-severity="CRITICAL"
                style="background:#1a2236; cursor:pointer;border-radius:18px;
                       padding:20px;display:flex;flex-direction:column;align-items:center;
                       justify-content:center;transition:box-shadow 0.2s;">
               <div style="font-size:2.2rem;font-weight:800;color:#f47174;">
                   {{ metrics.CRITICAL }}
               </div>
               <div style="color:#fff;margin-top:7px;font-size:0.95em;font-weight:600;">Critical</div>
           </div>
           
           <!-- High Severity Card -->
           <div class="severity-card" data-severity="HIGH"
                style="background:#1a2236;cursor:pointer;border-radius:18px;
                       padding:20px;display:flex;flex-direction:column;align-items:center;
                       justify-content:center;transition:box-shadow 0.2s;">
               <div style="font-size:2.2rem;font-weight:800;color:#fca311;">
                   {{ metrics.HIGH }}
               </div>
               <div style="color:#fff;margin-top:7px;font-size:0.95em;font-weight:600;">High</div>
           </div>
           
           <!-- Medium Severity Card -->
           <div class="severity-card" data-severity="MEDIUM"
                style="background:#1a2236;cursor:pointer;border-radius:18px;
                       padding:20px;display:flex;flex-direction:column;align-items:center;
                       justify-content:center;transition:box-shadow 0.2s;">
               <div style="font-size:2.2rem;font-weight:800;color:#3b8ded;">
                   {{ metrics.MEDIUM }}
               </div>
               <div style="color:#fff;margin-top:7px;font-size:0.95em;font-weight:600;">Medium</div>
           </div>
           
           <!-- Low Severity Card -->
           <div class="severity-card" data-severity="LOW"
                style="background:#1a2236;cursor:pointer;border-radius:18px;
                       padding:20px;display:flex;flex-direction:column;align-items:center;
                       justify-content:center;transition:box-shadow 0.2s;">
               <div style="font-size:2.2rem;font-weight:800;color:#42d392;">
                   {{ metrics.LOW }}
               </div>
               <div style="color:#fff;margin-top:7px;font-size:0.95em;font-weight:600;">Low</div>
           </div>
       </div>
   </div>

   <!-- Second Row: Simple Charts -->
   <div style="display: flex; gap: 25px; align-items: stretch;">
       <!-- Severity Distribution Chart -->
       <section style="background:#1a2236; border-radius:14px; padding:30px;
                      flex:1; display:flex; flex-direction:column; min-height:270px;">
           <div style="font-weight:700; color:#63a4ff; margin-bottom:15px;
                      font-size: 1.02rem; letter-spacing:0.15px; text-align:left;">
               Severity Distribution
           </div>
           <div style="display:flex; align-items:center; justify-content:center; flex:1;">
               <canvas id="severityPie" width="230" height="230"></canvas>
           </div>
       </section>
       
       <!-- Timeline Chart -->
       <section style="background:#1a2236; border-radius:14px; padding:30px;
                      flex:2; display: flex; flex-direction:column; min-height:270px;">
           <div style="font-weight:700; color:#63a4ff; margin-bottom:8px;
                      font-size: 1.02rem; letter-spacing:0.15px; text-align:left;">
               Vulnerabilities Over Time
           </div>
           <div style="position: relative; flex:1;">
               <canvas id="timelineChart"></canvas>
           </div>
       </section>
   </div>

   <!-- CVE List Section -->
   <div style="background:#1a2236; border-radius:14px; padding:30px;">
       <div style="font-weight:700; color:#63a4ff; margin-bottom:20px;
                  font-size: 1.02rem; letter-spacing:0.15px;">
           Recent Vulnerabilities
       </div>
       <div style="overflow-x: auto;">
           <table style="width: 100%; color: #e2e8f0; border-collapse: collapse;">
               <thead>
                   <tr style="border-bottom: 1px solid #374151;">
                       <th style="padding: 12px; text-align: left; font-weight: 600;">CVE ID</th>
                       <th style="padding: 12px; text-align: left; font-weight: 600;">Severity</th>
                       <th style="padding: 12px; text-align: left; font-weight: 600;">CVSS</th>
                       <th style="padding: 12px; text-align: left; font-weight: 600;">Description</th>
                       <th style="padding: 12px; text-align: left; font-weight: 600;">Published</th>
                   </tr>
               </thead>
               <tbody>
                   {% for cve in cves %}
                   <tr style="border-bottom: 1px solid #2d3748;">
                       <td style="padding: 12px;">
                           <a href="{{ url_for('cve_detail', cve_id=cve.ID) }}" 
                              style="color: #63a4ff; text-decoration: none;">
                               {{ cve.ID }}
                           </a>
                       </td>
                       <td style="padding: 12px;">
                           <span style="padding: 4px 8px; border-radius: 4px; font-size: 0.875rem;
                                       {% if cve.Severity == 'CRITICAL' %}background: #fecaca; color: #991b1b;
                                       {% elif cve.Severity == 'HIGH' %}background: #fed7aa; color: #9a3412;
                                       {% elif cve.Severity == 'MEDIUM' %}background: #dbeafe; color: #1e40af;
                                       {% elif cve.Severity == 'LOW' %}background: #dcfce7; color: #166534;
                                       {% else %}background: #f3f4f6; color: #374151;{% endif %}">
                               {{ cve.Severity or 'Unknown' }}
                           </span>
                       </td>
                       <td style="padding: 12px;">{{ cve.CVSS_Score or 'N/A' }}</td>
                       <td style="padding: 12px; max-width: 400px;">
                           {{ cve.Description[:100] }}{% if cve.Description|length > 100 %}...{% endif %}
                       </td>
                       <td style="padding: 12px;">{{ cve.Published[:10] if cve.Published else 'N/A' }}</td>
                   </tr>
                   {% endfor %}
               </tbody>
           </table>
       </div>
   </div>
</div>

<!-- JavaScript for Charts -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
<script>
// Data from Flask backend
window.timelineData = {{ timeline_data_years | tojson }};
window.timelineDataDaily = {{ timeline_data_days | tojson }};
window.severityStats = {{ severity_stats | tojson }};

// Initialize charts
document.addEventListener('DOMContentLoaded', function() {
   // Daily Trend Chart
   if (window.timelineDataDaily && window.timelineDataDaily.labels) {
       const dailyCtx = document.getElementById('dailyTrendChart');
       if (dailyCtx) {
           new Chart(dailyCtx, {
               type: 'line',
               data: {
                   labels: window.timelineDataDaily.labels,
                   datasets: [{
                       data: window.timelineDataDaily.values,
                       borderColor: '#63a4ff',
                       backgroundColor: 'transparent',
                       borderWidth: 2,
                       pointRadius: 0,
                       tension: 0.4
                   }]
               },
               options: {
                   responsive: true,
                   maintainAspectRatio: false,
                   plugins: { legend: { display: false } },
                   scales: {
                       x: { display: false },
                       y: { display: false }
                   }
               }
           });
       }
   }

   // Severity Pie Chart
   if (window.severityStats) {
       const pieCtx = document.getElementById('severityPie');
       if (pieCtx) {
           new Chart(pieCtx, {
               type: 'pie',
               data: {
                   labels: ['Critical', 'High', 'Medium', 'Low'],
                   datasets: [{
                       data: [
                           window.severityStats.CRITICAL || 0,
                           window.severityStats.HIGH || 0,
                           window.severityStats.MEDIUM || 0,
                           window.severityStats.LOW || 0
                       ],
                       backgroundColor: ['#f55855', '#f8a541', '#3b8ded', '#42d392'],
                       borderWidth: 0
                   }]
               },
               options: {
                   responsive: true,
                   maintainAspectRatio: false,
                   plugins: {
                       legend: {
                           position: 'bottom',
                           labels: { color: '#e2e8f0', padding: 20 }
                       }
                   }
               }
           });
       }
   }

   // Timeline Chart
   if (window.timelineData && window.timelineData.labels) {
       const timelineCtx = document.getElementById('timelineChart');
       if (timelineCtx) {
           new Chart(timelineCtx, {
               type: 'line',
               data: {
                   labels: window.timelineData.labels,
                   datasets: [{
                       label: 'CVEs',
                       data: window.timelineData.values,
                       borderColor: '#63a4ff',
                       backgroundColor: 'rgba(99, 164, 255, 0.1)',
                       borderWidth: 2,
                       fill: true,
                       tension: 0.4
                   }]
               },
               options: {
                   responsive: true,
                   maintainAspectRatio: false,
                   plugins: {
                       legend: { display: false }
                   },
                   scales: {
                       x: { 
                           ticks: { color: '#9ca3af' },
                           grid: { color: 'rgba(156, 163, 175, 0.1)' }
                       },
                       y: { 
                           ticks: { color: '#9ca3af' },
                           grid: { color: 'rgba(156, 163, 175, 0.1)' }
                       }
                   }
               }
           });
       }
   }
});
</script>
{% endblock %}